/*
 * behave.min.js
 *
 * Copyright 2013, Jacob Kelley - http://jakiestfu.com/
 * Released under the MIT Licence
 * http://opensource.org/licenses/MIT
 *
 * Github:  http://github.com/jakiestfu/Behave.js/
 * Version: 1.5
 */

(function(a){"use strict";var b=b||function(){var a={};return{add:function(b,c){if("object"==typeof b){var d;for(d=0;d<b.length;d++){var e=b[d];a[e]||(a[e]=[]),a[e].push(c)}}else a[b]||(a[b]=[]),a[b].push(c)},get:function(b){return a[b]?a[b]:void 0}}}(),c=c||function(c){"function"!=typeof String.prototype.repeat&&(String.prototype.repeat=function(a){if(1>a)return"";if(a%2)return this.repeat(a-1)+this;var b=this.repeat(a/2);return b+b}),"function"!=typeof Array.prototype.filter&&(Array.prototype.filter=function(a){if(null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if("function"!=typeof a)throw new TypeError;for(var d=[],e=arguments[1],f=0;c>f;f++)if(f in b){var g=b[f];a.call(e,g,f,b)&&d.push(g)}return d});var e,f,d={textarea:null,replaceTab:!0,softTabs:!0,tabSize:4,autoOpen:!0,overwrite:!0,autoStrip:!0,autoIndent:!0,fence:!1},g={keyMap:[{open:'"',close:'"',canBreak:!1},{open:"'",close:"'",canBreak:!1},{open:"(",close:")",canBreak:!1},{open:"[",close:"]",canBreak:!0},{open:"{",close:"}",canBreak:!0}]},h={_callHook:function(c,e){var f=b.get(c);if(e="boolean"==typeof e&&e===!1?!1:!0,f)if(e){var k,g=d.textarea,i=g.value,j=h.cursor.get();for(k=0;k<f.length;k++)f[k].call(a,{editor:{element:g,text:i,levelsDeep:h.levelsDeep()},caret:{pos:j},lines:{current:h.cursor.getLine(i,j),total:h.editor.getLines(i)}})}else for(k=0;k<f.length;k++)f[k].call(a)},defineNewLine:function(){var a=document.createElement("textarea");a.value="\n",f=2==a.value.length?"\r\n":"\n"},defineTabSize:function(a){return"undefined"!=typeof d.textarea.style.OTabSize?void(d.textarea.style.OTabSize=a):"undefined"!=typeof d.textarea.style.MozTabSize?void(d.textarea.style.MozTabSize=a):"undefined"!=typeof d.textarea.style.tabSize?void(d.textarea.style.tabSize=a):void 0},cursor:{getLine:function(a,b){return a.substring(0,b).split("\n").length},get:function(){if("number"==typeof document.createElement("textarea").selectionStart)return d.textarea.selectionStart;if(document.selection){var a=0,b=d.textarea.createTextRange(),c=document.selection.createRange().duplicate(),e=c.getBookmark();for(b.moveToBookmark(e);0!==b.moveStart("character",-1);)a++;return a}},set:function(a,b){if(b||(b=a),d.textarea.setSelectionRange)d.textarea.focus(),d.textarea.setSelectionRange(a,b);else if(d.textarea.createTextRange){var c=d.textarea.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",a),c.select()}},selection:function(){var e,g,i,j,k,a=d.textarea,b=0,c=0;return"number"==typeof a.selectionStart&&"number"==typeof a.selectionEnd?(b=a.selectionStart,c=a.selectionEnd):(g=document.selection.createRange(),g&&g.parentElement()==a&&(e=h.editor.get(),j=e.length,i=a.createTextRange(),i.moveToBookmark(g.getBookmark()),k=a.createTextRange(),k.collapse(!1),i.compareEndPoints("StartToEnd",k)>-1?b=c=j:(b=-i.moveStart("character",-j),b+=e.slice(0,b).split(f).length-1,i.compareEndPoints("EndToEnd",k)>-1?c=j:(c=-i.moveEnd("character",-j),c+=e.slice(0,c).split(f).length-1)))),b==c?!1:{start:b,end:c}}},editor:{getLines:function(a){return a.split("\n").length},get:function(){return d.textarea.value.replace(/\r/g,"")},set:function(a){d.textarea.value=a}},fenceRange:function(){if("string"==typeof d.fence){for(var a=h.editor.get(),b=h.cursor.get(),c=0,e=a.indexOf(d.fence),f=0;e>=0&&(f++,!(e+c>b));)c+=e+d.fence.length,a=a.substring(e+d.fence.length),e=a.indexOf(d.fence);return b>c&&e+c>b&&f%2===0?!0:!1}return!0},isEven:function(a,b){return b%2},levelsDeep:function(){var e,f,a=h.cursor.get(),b=h.editor.get(),c=b.substring(0,a),d=0;for(e=0;e<c.length;e++)for(f=0;f<g.keyMap.length;f++)g.keyMap[f].canBreak&&(g.keyMap[f].open==c.charAt(e)&&d++,g.keyMap[f].close==c.charAt(e)&&d--);var i=0,j=["'",'"'];for(e=0;e<g.keyMap.length;e++)if(g.keyMap[e].canBreak)for(f in j)i+=c.split(j[f]).filter(h.isEven).join("").split(g.keyMap[e].open).length-1;var k=d-i;return k>=0?k:0},deepExtend:function(a,b){for(var c in b)b[c]&&b[c].constructor&&b[c].constructor===Object?(a[c]=a[c]||{},h.deepExtend(a[c],b[c])):a[c]=b[c];return a},addEvent:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)},removeEvent:function(a,b,c){a.addEventListener?a.removeEventListener(b,c,!1):a.attachEvent&&a.detachEvent("on"+b,c)},preventDefaultEvent:function(a){a.preventDefault?a.preventDefault():a.returnValue=!1}},i={tabKey:function(a){if(h.fenceRange()){if(9==a.keyCode){h.preventDefaultEvent(a);var b=!0;h._callHook("tab:before");var c=h.cursor.selection(),d=h.cursor.get(),f=h.editor.get();if(c){for(var g=c.start;g--;)if("\n"==f.charAt(g)){c.start=g+1;break}var k,i=f.substring(c.start,c.end),j=i.split("\n");if(a.shiftKey){for(k=0;k<j.length;k++)j[k].substring(0,e.length)==e&&(j[k]=j[k].substring(e.length));i=j.join("\n"),h.editor.set(f.substring(0,c.start)+i+f.substring(c.end)),h.cursor.set(c.start,c.start+i.length)}else{for(k in j)j[k]=e+j[k];i=j.join("\n"),h.editor.set(f.substring(0,c.start)+i+f.substring(c.end)),h.cursor.set(c.start,c.start+i.length)}}else{var l=f.substring(0,d),m=f.substring(d),n=l+e+m;a.shiftKey?f.substring(d-e.length,d)==e&&(n=f.substring(0,d-e.length)+m,h.editor.set(n),h.cursor.set(d-e.length)):(h.editor.set(n),h.cursor.set(d+e.length),b=!1)}h._callHook("tab:after")}return b}},enterKey:function(a){if(h.fenceRange()&&13==a.keyCode){h.preventDefaultEvent(a),h._callHook("enter:before");var o,p,b=h.cursor.get(),c=h.editor.get(),d=c.substring(0,b),i=c.substring(b),j=d.charAt(d.length-1),k=i.charAt(0),l=h.levelsDeep(),m="",n="";if(l){for(;l--;)m+=e;for(m=m,o=m.length+1,p=0;p<g.keyMap.length;p++)g.keyMap[p].open==j&&g.keyMap[p].close==k&&(n=f)}else o=1;var q=d+f+m+n+m.substring(0,m.length-e.length)+i;h.editor.set(q),h.cursor.set(b+o),h._callHook("enter:after")}},deleteKey:function(a){if(h.fenceRange()&&8==a.keyCode){h.preventDefaultEvent(a),h._callHook("delete:before");var j,b=h.cursor.get(),c=h.editor.get(),d=c.substring(0,b),e=c.substring(b),f=d.charAt(d.length-1),i=e.charAt(0);if(h.cursor.selection()===!1){for(j=0;j<g.keyMap.length;j++)if(g.keyMap[j].open==f&&g.keyMap[j].close==i){var k=c.substring(0,b-1)+c.substring(b+1);return h.editor.set(k),void h.cursor.set(b-1)}var k=c.substring(0,b-1)+c.substring(b);h.editor.set(k),h.cursor.set(b-1)}else{var l=h.cursor.selection(),k=c.substring(0,l.start)+c.substring(l.end);h.editor.set(k),h.cursor.set(b)}h._callHook("delete:after")}}},j={openedChar:function(a,b){h.preventDefaultEvent(b),h._callHook("openChar:before");var c=h.cursor.get(),e=h.editor.get(),f=e.substring(0,c),g=e.substring(c),i=f+a.open+a.close+g;d.textarea.value=i,h.cursor.set(c+1),h._callHook("openChar:after")},closedChar:function(a,b){var c=h.cursor.get(),d=h.editor.get(),e=d.substring(c,c+1);return e==a.close?(h.preventDefaultEvent(b),h._callHook("closeChar:before"),h.cursor.set(h.cursor.get()+1),h._callHook("closeChar:after"),!0):!1}},k={filter:function(a){if(h.fenceRange()){var b=a.which||a.keyCode;if(39!=b&&(40!=b||0!==a.which)){var e,c=String.fromCharCode(b);for(e=0;e<g.keyMap.length;e++)if(g.keyMap[e].close==c){var f=d.overwrite&&j.closedChar(g.keyMap[e],a);!f&&g.keyMap[e].open==c&&d.autoOpen&&j.openedChar(g.keyMap[e],a)}else g.keyMap[e].open==c&&d.autoOpen&&j.openedChar(g.keyMap[e],a)}}},listen:function(){d.replaceTab&&h.addEvent(d.textarea,"keydown",i.tabKey),d.autoIndent&&h.addEvent(d.textarea,"keydown",i.enterKey),d.autoStrip&&h.addEvent(d.textarea,"keydown",i.deleteKey),h.addEvent(d.textarea,"keypress",k.filter),h.addEvent(d.textarea,"keydown",function(){h._callHook("keydown")}),h.addEvent(d.textarea,"keyup",function(){h._callHook("keyup")})}},l=function(a){a.textarea&&(h._callHook("init:before",!1),h.deepExtend(d,a),h.defineNewLine(),d.softTabs?e=" ".repeat(d.tabSize):(e="	",h.defineTabSize(d.tabSize)),k.listen(),h._callHook("init:after",!1))};this.destroy=function(){h.removeEvent(d.textarea,"keydown",i.tabKey),h.removeEvent(d.textarea,"keydown",i.enterKey),h.removeEvent(d.textarea,"keydown",i.deleteKey),h.removeEvent(d.textarea,"keypress",k.filter)},l(c)};"undefined"!=typeof module&&module.exports&&(module.exports=c),"undefined"==typeof ender&&(this.Behave=c,this.BehaveHooks=b),"function"==typeof define&&define.amd&&define("behave",[],function(){return c})}).call(this);
